function UndoHistory(a,b,c,d){this.container=a,this.maxDepth=b,this.commitDelay=c,this.editor=d;var e={text:"",from:null,to:null};this.first=e,this.last=e,this.firstTouched=!1,this.history=[],this.redoHistory=[],this.touched=[],this.lostundo=0}UndoHistory.prototype={scheduleCommit:function(){var a=this;parent.clearTimeout(this.commitTimeout),this.commitTimeout=parent.setTimeout(function(){a.tryCommit()},this.commitDelay)},touch:function(a){this.setTouched(a),this.scheduleCommit()},undo:function(){this.commit();if(this.history.length){var a=this.history.pop();this.redoHistory.push(this.updateTo(a,"applyChain")),this.notifyEnvironment();return this.chainNode(a)}},redo:function(){this.commit();if(this.redoHistory.length){var a=this.redoHistory.pop();this.addUndoLevel(this.updateTo(a,"applyChain")),this.notifyEnvironment();return this.chainNode(a)}},clear:function(){this.history=[],this.redoHistory=[],this.lostundo=0},historySize:function(){return{undo:this.history.length,redo:this.redoHistory.length,lostundo:this.lostundo}},push:function(a,b,c){var d=[];for(var e=0;e<c.length;e++){var f=e==c.length-1?b:document.createElement("br");d.push({from:a,to:f,text:cleanText(c[e])}),a=f}this.pushChains([d],a==null&&b==null),this.notifyEnvironment()},pushChains:function(a,b){this.commit(b),this.addUndoLevel(this.updateTo(a,"applyChain")),this.redoHistory=[]},chainNode:function(a){for(var b=0;b<a.length;b++){var c=a[b][0],d=c&&(c.from||c.to);if(d)return d}},reset:function(){this.history=[],this.redoHistory=[],this.lostundo=0},textAfter:function(a){return this.after(a).text},nodeAfter:function(a){return this.after(a).to},nodeBefore:function(a){return this.before(a).from},tryCommit:function(){!window||!window.parent||!window.UndoHistory||(this.editor.highlightDirty()?this.commit(!0):this.scheduleCommit())},commit:function(a){parent.clearTimeout(this.commitTimeout),a||this.editor.highlightDirty(!0);var b=this.touchedChains(),c=this;b.length&&(this.addUndoLevel(this.updateTo(b,"linkChain")),this.redoHistory=[],this.notifyEnvironment())},updateTo:function(a,b){var c=[],d=[];for(var e=0;e<a.length;e++)c.push(this.shadowChain(a[e])),d.push(this[b](a[e]));b=="applyChain"&&this.notifyDirty(d);return c},notifyDirty:function(a){forEach(a,method(this.editor,"addDirtyNode")),this.editor.scheduleHighlight()},notifyEnvironment:function(){this.onChange&&this.onChange(this.editor),window.frameElement&&window.frameElement.CodeMirror.updateNumbers&&window.frameElement.CodeMirror.updateNumbers()},linkChain:function(a){for(var b=0;b<a.length;b++){var c=a[b];c.from?c.from.historyAfter=c:this.first=c,c.to?c.to.historyBefore=c:this.last=c}},after:function(a){return a?a.historyAfter:this.first},before:function(a){return a?a.historyBefore:this.last},setTouched:function(a){a?a.historyTouched||(this.touched.push(a),a.historyTouched=!0):this.firstTouched=!0},addUndoLevel:function(a){this.history.push(a),this.history.length>this.maxDepth&&(this.history.shift(),this.lostundo+=1)},touchedChains:function(){function g(a,b){var c=b+"Sibling",d=a[c];while(d&&!isBR(d))d=d[c];return d}function e(b){var c=[];for(var d=b?b.nextSibling:a.container.firstChild;d&&(!isBR(d)||d.hackBR);d=d.nextSibling)!d.hackBR&&d.currentText&&c.push(d.currentText);return{from:b,to:d,text:cleanText(c.join(""))}}function d(a,c){a?a.historyTemp=c:b=c}function c(a){return a?a.historyTemp:b}var a=this,b=null,f=[];a.firstTouched&&a.touched.push(null),forEach(a.touched,function(b){if(!b||b.parentNode==a.container&&!b.hackBR){b?b.historyTouched=!1:a.firstTouched=!1;var c=e(b),g=a.after(b);if(!g||g.text!=c.text||g.to!=c.to)f.push(c),d(b,c)}});var h=[];a.touched=[],forEach(f,function(b){if(!!c(b.from)){var f=[],i=b.from,j=!0;for(;;){var k=c(i);if(!k){if(j)break;k=e(i)}f.unshift(k),d(i,null);if(!i)break;j=a.after(i),i=g(i,"previous")}i=b.to,j=a.before(b.from);for(;;){if(!i)break;var k=c(i);if(!k){if(j)break;k=e(i)}f.push(k),d(i,null),j=a.before(i),i=g(i,"next")}h.push(f)}});return h},shadowChain:function(a){var b=[],c=this.after(a[0].from),d=a[a.length-1].to;for(;;){b.push(c);var e=c.to;if(!e||e==d)break;c=e.historyAfter||this.before(d)}return b},applyChain:function(a){function d(a,b){var d=a?a.nextSibling:c.container.firstChild;while(d!=b){var e=d.nextSibling;removeElement(d),d=e}}var b=select.cursorPos(this.container,!1),c=this,e=a[0].from,f=a[a.length-1].to;d(e,f);for(var g=0;g<a.length;g++){var h=a[g];g>0&&c.container.insertBefore(h.from,f);var i=makePartSpan(fixSpaces(h.text));c.container.insertBefore(i,f);if(b&&b.node==h.from){var j=0,k=this.after(h.from);if(k&&g==a.length-1){for(var l=0;l<b.offset&&h.text.charAt(l)==k.text.charAt(l);l++);b.offset>l&&(j=h.text.length-k.text.length)}select.setCursorPos(this.container,{node:h.from,offset:Math.max(0,b.offset+j)})}else b&&g==a.length-1&&b.node&&b.node.parentNode!=this.container&&select.setCursorPos(this.container,{node:h.from,offset:h.text.length})}this.linkChain(a);return e}}