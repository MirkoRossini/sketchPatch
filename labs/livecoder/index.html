<!doctype html>
<html>
	<head>
		<title>Yet to be named</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		
			
		<script src="vendor/three.js/Three.js"></script>
		<script src="vendor/three.js/Detector.js"></script>
		<!-- https://github.com/mrdoob/stats.js -->
		<script src="vendor/three.js/Stats.js"></script>

		<script src="vendor/threex/THREEx.WindowResize.js"></script>
		<script type="text/javascript" src="coffee-script.js"></script>


		<link  href="css/main.css" rel="stylesheet"/>
		<link rel="stylesheet" href="codemirror.css">
		<script src="codemirror.js"></script>
		<link rel="stylesheet" href="night.css">
		<script src="coffeescriptModified.js"></script>
		<script src="jquery.min.js"></script>
		<script src="jquery.viewport.js"></script>
	
		<style type="text/css">
		  .CodeMirror {border: none; }
		</style>

		<!-- second drop-down menu -->
			<style type="text/css">
					.dd_menu {background:green; padding:0px; margin:0; list-style-type:none; height:30px;}
					.dd_menu li {float:left; height:30px; border-right: solid 1px white;}
					.dd_menu li a {padding:9px 20px; display:block; color:#fff; text-decoration:none; font:12px arial, verdana, sans-serif; font-weight: bold;}
					.dd_menu li:hover a {text-decoration:underline;}
					
					.dd_menu ul { position:absolute; left:-9999px; top:-9999px; list-style-type:none;}
					.dd_menu li:hover {position:relative; background:red;}
					.dd_menu li:hover ul {left:0px; top:30px; background:lavender; padding:3px; border:1px solid grey; width:160px;}
					.dd_menu li:hover ul li {height:18px; border:none;}
					.dd_menu li:hover ul li a {height:18px; padding:0px; display:block; font-size:11px; width:158px; line-height:18px; text-indent:5px; color:#444; background-color:lavender; text-decoration:none; border:1px solid transparent;}
					.dd_menu li:hover ul li a:hover {height:18px; background:silver; color:#000; border:solid 1px #444;}
					
					#dangerSignText {color:green; text-decoration:none;}
					#dangerSign:hover {background:green;}

					#errorMessageText {text-decoration:none;}
					#errorMessage:hover {background:green;}
					
			</style>
		<!-- end of second drop-down menu -->

		<!-- start modal stuff-->
			<!-- Page styles -->
			<link type='text/css' href='simpleModal/css/demo.css' rel='stylesheet' media='screen' />			
			<!-- Contact Form CSS files -->
			<link type='text/css' href='simpleModal/css/basic.css' rel='stylesheet' media='screen' />
			<!-- Scripts -->
			<script type='text/javascript' src='simpleModal/js/jquery.js'></script>
			<script type='text/javascript' src='simpleModal/js/jquery.simplemodal.js'></script>
			<script type='text/javascript' src='simpleModal/js/basic.js'></script>

		<!-- end modal stuff-->

	</head>
<body>

		<!-- preload the images -->
		<div style='display:none'>
			<img src='simpleModal/img/basic/x.png' alt='' />
		</div>


		<!-- modal content -->
		<div id="basic-modal-content">
			<h3>What is this?</h3>
			<p>This is a livecoding environment: you type a program and it is immediately executed for you.<br><br>Try one of the examples from the "Examples" menu.
			</div>

<div id="theMenu" style="position: absolute;  z-index:3; top: 0px; left: 0px;">

<ul class='dd_menu' >

	<li><a href="#">Help</a>
		<ul>
			<!--<li><a href="#" onclick='Boxy.alert("This is a livecoding environment:<br><br>you type a program and it is immediately executed for you.<br><br>Try copying this and pasting it in the main window:<br><br><xmp>rotate 0,1,frame/100\nbox</xmp>");' >What is this?</a></li> -->
			<li><a href="#" onclick="$('#basic-modal-content').modal();">What is this?</a></li>
		</ul>
	</li>

	<li><a href="#">Examples</a>
		<ul>
		
			<li><a href="#" onclick="loadExample('simpleCubeExample');">Simple cube</a></li>
			<li><a href="#" onclick="loadExample('twoCubesExample');">Two cubes</a></li>
			<li><a href="#" onclick="loadExample('cubesAndSpikes');">Cubes and spikes</a></li>
			<li><a href="#" onclick="loadExample('turbineExample');">Turbine</a></li>
			<li><a href="#" onclick="loadExample('yellowBackgroundExample');">Yellow background</a></li>
			<li><a href="#" onclick="loadExample('littleSpiralOfCubes');">Little spiral</a></li>
			<li><a href="#" onclick="loadExample('tentacleExample');">Tentacle</a></li>
			<li><a href="#" onclick="loadExample('simpleSoundExample');">Simple sound</a></li>
			<li><a href="#" onclick="loadExample('simpleRhythmExample');">Simple rhythm</a></li>
			<li><a href="#" onclick="loadExample('industrialMusicExample');">Industrial music</a></li>
		</ul>
	</li>
	<li id="dangerSign"><a href="#" id="dangerSignText" style="font-size:2em;margin-top:-0.5em;">&#9888;</a>
	</li>
	<li id="errorMessage"><a href="#" id="errorMessageText" ></a>
	</li>

</ul>
</div>




<div name="miao" id="miao" style="position: absolute;  top: 30px; left: 0px; width: 100%; font-size: 3em;">

<canvas id="backGroundCanvas" style="position: absolute; z-index:-2; top: 0px; left: 0px;" width="100" height="100"></canvas> 



		<form autocapitalize="off" autocorrect="off" wrap="off"><textarea id="code" name="code" style="z-index:1" autocapitalize="off" autocorrect="off" wrap="off" ></textarea></form>

      </div>

	<!-- three.js container -->
    	<div id="container" style="position: absolute; z-index:-1; top: 0px; left: 0px;"></div>
	<!-- info on screen display 
	<div id="info">
		<div class="bottom" id="inlineDoc" >
			- <i>p</i> for screenshot
		</div> 
	</div>
	-->

	<script type="text/javascript">
		var stats, scene, renderer;
		var camera;

  // creating a geometry is expensive
  // so we need to create ONE cube of dimensions 1,1,1
  // if we need a cube of different size, then we need to
  // scale it. Note that the scale for the specific cube shouldn't
  // influence the stack, so we need to create a scale node,
  // and then go up a node.
  var isWebGLUsed = false;
  var normalMaterial = new THREE.MeshNormalMaterial()
  var cubeGeometry = new THREE.CubeGeometry(1,1,1);
  var cameraFilterMaterial = new THREE.MeshBasicMaterial( { color: 0xffaa00, transparent: true, opacity: 0.1, blending: THREE.NormalBlending } ) ;
  var cameraFilterGeometry = new THREE.PlaneGeometry( 1, 1, 1,1 );				
  var cameraFilter = new THREE.Mesh(cameraFilterGeometry, cameraFilterMaterial);

  // loads identity matrix
  var worldMatrix = new THREE.Matrix4();

var midgroundScene;
var midgroundSceneContext;
var finalscene;
var finalsceneContext;
var backgroundScene;
var backgroundSceneContext;
var backgroundScene;
var backgroundSceneContext;
var potentiallyUseWebGL = true;
var useRequestAnimationFrame = false;
var wantedFramesPerSecond = 30;
var backGroundFraction = 15;
var scaledBackgroundWidth;
var scaledBackgroundHeight;
var repaintBackroundEveryFrame = true;
var fullScreenifyBackground = true;

var soundLoops = [];
soundLoops.soundIDs = [];
soundLoops.beatStrings = [];

var programHasBasicError = false;
var reasonOfBasicError = "";
var consecutiveFramesWithoutRunTimeError = 0;
var out;
var lastStableProgram;

		// init the scene
		function init(){

			scaledBackgroundWidth = Math.floor(window.innerWidth / backGroundFraction);
			scaledBackgroundHeight = Math.floor(window.innerHeight / backGroundFraction);

			if( Detector.webgl && potentiallyUseWebGL ){

				midgroundScene = document.createElement('canvas');
				
				renderer = new THREE.WebGLRenderer({
					canvas: midgroundScene,
					antialias		: true,	// to get smoother output					
					preserveDrawingBuffer	: false	// to allow screenshot
				});
			   
			   //renderer.autoClearColor = false;
			   //renderer.autoClear = false;
			   isWebGLUsed = true;
			   
			   // this is really a bad hack, but chrome goes twice
			   // as fast with this, while safari doesn't work,
			   // and firefox is the fastest no matter what
			   if (navigator.userAgent.toLowerCase().indexOf('chrome') > -1) {
			   	renderer.autoClear = false;
			   }
			   
				finalscene = document.createElement('canvas');
				finalscene.width = window.innerWidth;
				finalscene.height = window.innerHeight;
				finalsceneContext = finalscene.getContext('2d');
		
				backgroundScene = document.getElementById('backGroundCanvas');  
				backgroundScene.width = scaledBackgroundWidth;
				backgroundScene.height = scaledBackgroundHeight;
				backgroundSceneContext = backgroundScene.getContext('2d');
				
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.getElementById('container').appendChild(midgroundScene);
				//document.getElementById('backGroundCanvas').appendChild(backgroundScene);

			}else{
			
			
			 // we always draw the 3d scene off-screen
				midgroundScene = document.createElement('canvas');
				midgroundSceneContext = midgroundScene.getContext('2d');
				renderer	= new THREE.CanvasRenderer({
					canvas: midgroundScene,
					antialias		: true,	// to get smoother output					
					preserveDrawingBuffer	: false	// to allow screenshot
				});
			   	
			   	//renderer.autoClear = true;
			   	//renderer.setClearColorHex( 0x000000, 1 );


				finalscene = document.createElement('canvas');
				finalscene.width = window.innerWidth;
				finalscene.height = window.innerHeight;
				finalsceneContext = finalscene.getContext('2d');
		
				backgroundScene = document.getElementById('backGroundCanvas');  
				backgroundScene.width = scaledBackgroundWidth;
				backgroundScene.height = scaledBackgroundHeight;
				backgroundSceneContext = backgroundScene.getContext('2d');
				
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.getElementById('container').appendChild(midgroundScene);
			}





			// add Stats.js - https://github.com/mrdoob/stats.js
			stats = new Stats();
			stats.domElement.style.position	= 'absolute';
			stats.domElement.style.bottom	= '0px';
			document.body.appendChild( stats.domElement );

			scene = new THREE.Scene();
			scene.matrixAutoUpdate = false;


			// put a camera in the scene
			camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1, 10000 );
			camera.position.set(0, 0, 5);
			scene.add(camera);

			// transparently support window resize
			THREEx.WindowResize.bind(renderer, camera);
			


}

		

		// render the scene
		var gradientDrawn = false;
		function render() {

		
			if (repaintBackroundEveryFrame || (!gradientDrawn)) {
			var diagonal = Math.sqrt(Math.pow(scaledBackgroundWidth/2,2)+ Math.pow( scaledBackgroundHeight/2,2));
			var radgrad = backgroundSceneContext.createRadialGradient(scaledBackgroundWidth/2, scaledBackgroundHeight/2, 0,scaledBackgroundWidth/2, scaledBackgroundHeight/2, diagonal);  
			radgrad.addColorStop(0, '#FF5F98');  
			radgrad.addColorStop(0.75, '#FF0188');  
			radgrad.addColorStop(1, 'rgba(255,1,136,0)');    
			
			backgroundSceneContext.globalAlpha = 1.0;
			backgroundSceneContext.fillStyle = radgrad;
			backgroundSceneContext.beginPath();
			backgroundSceneContext.rect(0,0,scaledBackgroundWidth,scaledBackgroundHeight);
			backgroundSceneContext.closePath();
			backgroundSceneContext.fill();
			
			var gradObj = backgroundSceneContext.createLinearGradient(scaledBackgroundWidth/2,0,scaledBackgroundWidth/2,scaledBackgroundHeight/2);
			gradObj.addColorStop(0.0, "#ff0000");
			gradObj.addColorStop(1.0, "#aa0000");

			backgroundSceneContext.globalAlpha = 0.3;
			backgroundSceneContext.fillStyle = gradObj;
			backgroundSceneContext.beginPath();
			backgroundSceneContext.rect(0,0,scaledBackgroundWidth,scaledBackgroundHeight);
			backgroundSceneContext.closePath();
			backgroundSceneContext.fill();
			
			
			gradientDrawn = true;
			}
			////////////////////////

			if (!isWebGLUsed){
			  midgroundSceneContext.clearRect(0, 0, window.innerWidth,window.innerHeight);
			}

			// the renderer draws into an offscreen canvas called midgroundScene
			renderer.render( scene, camera );
				
		}
		
		
var drawLoopTimer = null;
var frame = 0;


if( !init() )	animate();

function clearDisplayList() {
	for(var i = 0; i < scene.objects.length; ++i) {
			scene.remove(scene.objects[i]);
			i--;
	}
}

function runCode() {
    

      try {
      
        var editorContent = editor.getValue();
        var copyOfEditorContent;
        var programIsMangled = false;
        var programContainsStringsOrComments = false;
        var characterBeingExamined;
        var nextCharacterBeingExamined;
        
        // according to jsperf, this is the fastest way to count for
        // occurrences of a character. We count apostrophes


		// check whether the program potentially
		// contains strings or comments
		// if it doesn't then we can do some
		// simple syntactic checks that are likely
		// to be much faster than attempting a
		// coffescript to javascript translation
        copyOfEditorContent = editorContent;
		while (copyOfEditorContent.length) {
			characterBeingExamined = copyOfEditorContent.charAt(0);
			nextCharacterBeingExamined = copyOfEditorContent.charAt(1);
		  if (characterBeingExamined === "'" ||
		  	characterBeingExamined === '"' ||
		  	(characterBeingExamined === "/" &&
		  		(
		  		nextCharacterBeingExamined === "*" ||
		  		nextCharacterBeingExamined === "/"
		  		)
		  	)
		  	) {
			  programContainsStringsOrComments = true;
			  //alert('program contains strings or comments');
			  break;
		   }
		   copyOfEditorContent = copyOfEditorContent.slice(1);
		}

        // let's do a quick check:
        // these groups of characters should be in even number:
        // ", ', (), {}, []
        
		if (programContainsStringsOrComments) {
			// OK the program contains comments and/or strings
			// so this is what we are going to do:
			// first we remove all the comments for good
			// then we create a version without the strings
			// so we can perform some basic syntax checking.
			// Note that when we remove the comments we also need to
			// take into account strings because otherwise we mangle a line like
       	 	// print "frame/100 //"
       	 	// where we need to now that that single comment is actually the content
       	 	// of a string.
		
			// modified from Processing.js (search for: "masks strings and regexs")
			// this is useful to remove all comments but keeping all the strings
			// the difference is that here I don't treat regular expressions.
			// Note that string take precedence over comments i.e.
			// is a string, not half a string with a quote in a comment

			// get rid of the comments for good.
			editorContent = editorContent.replace(/("(?:[^"\\\n]|\\.)*")|('(?:[^'\\\n]|\\.)*')|(\/\/[^\n]*\n)|(\/\*(?:(?!\*\/)(?:.|\n))*\*\/)/g,
			function(all, quoted, aposed, singleComment, comment) {
			  // strings are kept as they are
			  if(quoted) {
				return quoted;
			  }
			  else if(aposed) {
				return aposed;
			  }
			  // eliminate comments
			  else {
				return "";
			  }
			});
			
			// ok now in the version we use for syntax checking we delete all the strings
			copyOfEditorContent = editorContent.replace(/("(?:[^"\\\n]|\\.)*")|('(?:[^'\\\n]|\\.)*')/g,"");

		}
		else {
		    copyOfEditorContent = editorContent;
		}
		
			var aposCount = 0;
			var quoteCount = 0;
			var roundBrackCount = 0;
			var curlyBrackCount = 0;
			var squareBrackCount = 0;
			
			while (copyOfEditorContent.length) {
				characterBeingExamined = copyOfEditorContent.charAt(0)
			
			  if ( characterBeingExamined === "'") {
				  aposCount += 1;
				}
			  else if (characterBeingExamined === '"') {
				  quoteCount += 1;
				}
			  else if (characterBeingExamined === '(' || characterBeingExamined === ')' ) {
				  roundBrackCount += 1;
				}
			  else if (characterBeingExamined === '{' || characterBeingExamined === '}' ) {
				  curlyBrackCount += 1;
				}
			  else if (characterBeingExamined === '[' || characterBeingExamined === ']' ) {
				  squareBrackCount += 1;
				}
			   copyOfEditorContent = copyOfEditorContent.slice(1);
			}
			
			// according to jsperf, the fastest way to check if number is even/odd
			if (
				aposCount & 1 ||
				quoteCount & 1 ||
				roundBrackCount & 1 ||
				curlyBrackCount & 1 ||
				squareBrackCount & 1
			){
				programHasBasicError = true;
				//alert("basic error");
				//alert("p:" + $('#dangerSignText').css('color'));
				$('#dangerSignText').css('color','red')

			if (aposCount & 1) reasonOfBasicError = "Missing '";
			if (quoteCount & 1) reasonOfBasicError = 'Missing "';
			if (roundBrackCount & 1) reasonOfBasicError = "Unbalanced ()";
			if (curlyBrackCount & 1) reasonOfBasicError = "Unbalanced {}";
			if (squareBrackCount & 1) reasonOfBasicError = "Unbalanced []";

				$('#errorMessageText').text(reasonOfBasicError)
				
				
				return;
			}
		
        
      	// indent the code
        var elaboratedSource = "\t"+editorContent.replace(
			new RegExp( "\\n", "g" ), "\n\t"
		);
        elaboratedSource = "draw = ->\n" + elaboratedSource;
        
        // little trick. This is mangled up in the translation from coffeescript
        // (1).times ->
        // But this isn't:
        // (1+0).times ->
        // So here is the little replace.
        
        // TODO: you should be a little smarter about the substitution of the draw method
        // You can tell a method declaration because the line below is indented
        // so you should check that.
        
        
        //elaboratedSource =  elaboratedSource.replace(/^([a-z]+[a-zA-Z1-9]+)\s*$/gm, "$1 = ->" );
        
        // some replacements add a semicolon for the
        // following reason: coffeescript allows you to split arguments
        // over multiple lines.
        // So if you have:
        //   rotate 0,0,1
        //   box
        // and you want to add a scale like so:
        //   scale 2,2,2
        //   rotate 0,0,1
        //   box
        // What happens is that as you are in the middle of typing:
        //   scale 2,
        //   rotate 0,0,1
        //   box
        // coffeescript takes the rotate as the second argument of scale
        // causing mayhem.
        // Instead, all is good if rotate is prepended with a semicolon.
        
        
        elaboratedSource =  elaboratedSource.replace(/(\d+)\s+times/g, ";( $1 + 0).times ->" );

        elaboratedSource =  elaboratedSource.replace(/^(\s*)([a-z]+[a-zA-Z1-9]+)[ ]*$/gm, "$1;$2()" );
        // we don't want if and for to undergo the same tratment as, say, box
        // so put those back to normal.
        elaboratedSource =  elaboratedSource.replace(/;if\(\)/g, ";if" );
        elaboratedSource =  elaboratedSource.replace(/;for\(\)/g, ";for" );

        elaboratedSource =  elaboratedSource.replace(/\/\//g, "#" );
        elaboratedSource =  elaboratedSource.replace(/scale(\s)+/g, ";scale$1" );
        elaboratedSource =  elaboratedSource.replace(/rotate(\s)+/g, ";rotate$1" );
        elaboratedSource =  elaboratedSource.replace(/translate(\s)+/g, ";translate$1" );
        
        // the semicolo mangles the first line of the function definitions
        // coffeescript doesn't like that
        elaboratedSource =  elaboratedSource.replace(/->(\s+);/g, "->$1" );
        
      
        //alert(elaboratedSource );
        out = CoffeeScript.compile(elaboratedSource, {
          bare: "on"
        });
        //alert("in javascript: " + out);
        
      } catch (e) {
			$('#dangerSignText').css('color','red')
			$('#errorMessageText').text(""+e)
        return;
      }

				programHasBasicError = false;
				reasonOfBasicError = "";
				$('#dangerSignText').css('color','green')
				$('#errorMessageText').text(reasonOfBasicError)

	// see here for the deepest examination ever of "eval"
	// http://perfectionkills.com/global-eval-what-are-the-options/
	// note that exceptions are caught by the window.onerror callback
	consecutiveFramesWithoutRunTimeError = 0;
	window.eval(out);

      
}

window.onerror=function(msg, url, linenumber){
 $('#dangerSignText').css('color','red');
 $('#errorMessageText').text(msg);
 
 // we set this to 6 because we save it as stable
 // when it's 5, so we avoid re-saving.
 consecutiveFramesWithoutRunTimeError = 6;
 window.eval(lastStableProgram);

 return true
}

function background(red, green, blue) {

			clearDisplayList();

			// canvas renderer
			theColor = new THREE.Color();
			theColor.setRGB(red, green,blue);
			renderer.setClearColor(theColor,1);



}

// animation loop
    	function animate() {

			// loop on request animation loop
			// - it has to be at the begining of the function
			// - see details at http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
			// requestAnimationFrame seems to only do 60 fps, which in my case is too much,
			// I rather prefer to have a slower framerate but steadier.
			
			if (useRequestAnimationFrame) {
				requestAnimationFrame( animate );
			}
			else {
				setTimeout( 'animate();', 1000 / wantedFramesPerSecond );
			}

			//clearDisplayList();
			worldMatrix.identity();

			// the sound list needs to be cleaned
			// and the beatsPerMinute set to zero
			// so that the user program can create its own from scratch
			beatsPerMinute = 0;
			soundLoops.soundIDs = [];
			soundLoops.beatStrings = [];


			//rootObject = new THREE.Object3D();
			//scene.add(rootObject);
			//parentObject = rootObject;

			if (typeof(draw) != "undefined") { 
			  draw();
			  frame++;
			  consecutiveFramesWithoutRunTimeError++;
			  if (consecutiveFramesWithoutRunTimeError == 5) {
			  	lastStableProgram = out;
			  }
			}

			// do the render
			render();
			clearDisplayList();

			// update stats
			stats.update();
		}

	/*
	var lastkey = 0
	 document.onkeydown = function(e){
		// CTRL-K compiles and runs
		if(lastkey == 17 && e.which==75){
			runCode();
			return false;
		}
		else {
			lastkey = e.which;
		}
		// also up or down arrow compile and run
		if(e.which==38 || e.which==40){
			runCode();
			return true;
		}		
	};

	document.onkeyup = function(e){
		
		if(e.which==17){
			lastkey = 0;
		}
	};
		*/	


var parentObject, rootObject, rotate, translate;
parentObject = 0;
rootObject = 0;
var currentObject;
var beatsPerMinute = 0;
var oldBeatsPerMinute = 0;
var soundLoopTimer;
var beatNumber = 0;

bpm = function(a) {

	beatsPerMinute = a;
	if (oldBeatsPerMinute !== a){
		//alert('changing beats per minute old ' + oldBeatsPerMinute + ' new: ' + a);
		clearTimeout(soundLoopTimer);
		
		if (beatsPerMinute !== 0) {
				soundLoopTimer = setTimeout('soundLoop();',(1000*60)/beatsPerMinute);
		}
    	oldBeatsPerMinute = beatsPerMinute;
    }
	//alert('AFTER old ' + oldBeatsPerMinute + ' new: ' + a);

}

soundLoop = function() {
			clearTimeout(soundLoopTimer);
			//alert('soundLoop');
			
			if (beatsPerMinute !== 0) {
					soundLoopTimer = setTimeout('soundLoop();',(1000*60)/beatsPerMinute);
			}
			
			beatNumber++;
			beatNumber = beatNumber % 16;

			//alert(' '+soundLoops.soundIDs.length);
			for(var i in soundLoops.soundIDs){
				var playOrNoPlay;
				playOrNoPlay = soundLoops.beatStrings[i].charAt(beatNumber);
				//alert('soundID: ' + soundLoops.soundIDs[i]);
				if (playOrNoPlay === 'x') {
					soundManager.play(soundLoops.soundIDs[i])
				}
			}
}


addSound = function(soundID,beatString) {

    		soundLoops.soundIDs[soundLoops.soundIDs.length] = soundID;
    		soundLoops.beatStrings[soundLoops.beatStrings.length] = beatString;

}

translate = function(a, b, c) {
  /*
  currentObject = new THREE.Object3D();
  currentObject.position.x = a;
  currentObject.position.y = b;
  currentObject.position.z = c;
  parentObject.add(currentObject);
  parentObject = currentObject;
  */
  worldMatrix.translate(new THREE.Vector3(a,b,c));
};

rotate = function(a, b, c) {

  if(arguments.length == 0){
  	  return;
  }
  else if(arguments.length == 1){
  	  b=a; c=a;
  }
  else if(arguments.length == 2){
  	  c=0;
  }

  /*
  currentObject = new THREE.Object3D();
  currentObject.rotation.x = a;
  currentObject.rotation.y = b;
  currentObject.rotation.z = c;
  parentObject.add(currentObject);
  parentObject = currentObject;
  */
  //worldMatrix.setRotationFromEuler(new THREE.Vector3(a,b,c));
  worldMatrix.rotateX(a).rotateY(b).rotateZ(c);

};

scale = function(a, b, c) {
  if(arguments.length == 0){
  	  return;
  }
  else if(arguments.length == 1){
  	  b=a; c=a;
  }
  else if(arguments.length == 2){
  	  c=1;
  }
  
  // odd things happen setting scale to zero
  if (a < 0.000000001) a = 0.000000001;
  if (b < 0.000000001) b = 0.000000001;
  if (c < 0.000000001) c = 0.000000001;

  /*
  currentObject = new THREE.Object3D();
  currentObject.scale.x = a;
  currentObject.scale.y = b;
  currentObject.scale.z = c;
  parentObject.add(currentObject);
  parentObject = currentObject;
  */
  worldMatrix.scale(new THREE.Vector3(a,b,c));

};
    
  box = function(a,b,c) {
  	
  	if(a === undefined){
  	  //alert('cube!')
  	  a=1; b=1; c=1;
  	  }
  	  
  	else if(arguments.length === 1){
  	  b=a; c=a;
  	  }
  	// create a distinct scale node
  	//var shouldAttachHere = parentObject;
    //scale(a,b,c);
    //var mesh = new THREE.Mesh(cubeGeometry, normalMaterial)


    var mesh = new THREE.Mesh(cubeGeometry, normalMaterial);

    // the cube we are going to add is subject to the scale we just
    // did, so the size should be OK
    //parentObject.add(mesh)
    // now we need to escape the scale node that we used to size the cube
    // otherwise all further translations/rotations/scales are going
    // to be affected.
    //parentObject = shouldAttachHere
    mesh.matrixAutoUpdate = false;
    mesh.matrix.copy(worldMatrix);
  	if( a !== 1 || b !== 1 || c !== 1){
      mesh.matrix.scale(new THREE.Vector3(a,b,c));
      // in theory the docs say that we should change the boundradius
      // but I don't think that we need it...
      //mesh.boundRadiusScale = Math.max(a,b,c);
    }
    
    scene.add(mesh);
    


  }

/**
 * extend the Number prototype
 * @param func
 * @param scope [optional]
 */
Number.prototype.times = function(func, scope){
    var v = this.valueOf();
    for (var i=0; i < v; i++){
        func.call(scope||window,i);
    }
};


/*


To set the flash security settings:
http://www.macromedia.com/support/documentation/en/flashplayer/help/settings_manager04.html

/////////////////////////////

bpm 350
//addSound 's12','zzzzzzzzzzzzzzzx'
addSound 'additional13'  ,'zzx z zzzzxzzzzzzx'
addSound 'additional9'  ,'zxzx z zxzzxxxxxxx'
addSound 'additional7'  ,'zzxz z zzzxzzzzzzx'
addSound 'additional1'  ,'zzxz z zzzzzzzzzzx'
addSound 'additional8'  ,'xzzx z zzxzzzxzzxz'
addSound 'additional6' ,'xxzz x zxzxzxxxxxx'
addSound 'additional4' ,'zxzxzzzxzxxzzzxx'
scale 2*Math.sin(frame/33)
rotate frame/10,frame/250,frame/50
box

//////////////////////////////

*/

var simpleCubeExample = ""+
	"rotate 0, 1, frame/100\n"+
	"box\n";

var twoCubesExample = ""+
""+		"2 times\n"+
"\t"+		"rotate 0, 1, frame/200\n"+
"\t"+		"box\n";

var cubesAndSpikes = ""+
""+		"scale 2.1\n"+
""+		"5 times\n"+
"\t"+			"rotate 0,1,frame/500\n"+
"\t"+			"box 0.1,0.1,0.1\n"+
"\t"+			"translate 0,0.1,0.1\n"+
"\t"+			"3 times\n"+
"\t\t"+				"rotate 0,1,1\n"+
"\t\t"+				"box 0.01,0.01,1\n";

var turbineExample = ""+
""+		"70 times\n"+
"\t"+		"rotate frame/101,1,frame/1000\n"+
"\t"+		"box\n";

var yellowBackgroundExample = ""+
""+		"background 255,255,0\n"+
""+		"rotate 0,frame/20,frame/20\n"+
""+		"box\n";

var simpleSoundExample = ""+
""+		"rotate 0,1,frame/100\n"+
""+		"box\n"+
""+		"if frame % 20 == 0\n"+
"\t"+		"soundManager.play('s12')\n";

var littleSpiralOfCubes = ""+
""+		"scale 0.1\n"+
""+		"10 times\n"+
"\t"+		"rotate 0,1,frame/100\n"+
"\t"+		"translate 1,1,1\n"+
"\t"+		"box\n";

var tentacleExample = ""+
""+		"scale 0.1\n"+
""+		"3 times\n"+
"\t"+		"rotate 0,1,1\n"+
"\t"+		"10 times\n"+
"\t\t"+		"rotate 0,1,frame/100\n"+
"\t\t"+		"scale 0.9\n"+
"\t\t"+		"translate 1,1,1\n"+
"\t\t"+		"box\n";

var simpleRhythmExample = ""+
""+		"bpm 240\n"+
""+		"addSound 's12','xzzzzzzzzzzzzzzz'\n"+
""+		"addSound 's1'  ,'zzxzzzzzxzzzzzzx'\n"+
""+		"addSound 's2'  ,'xzzxzzxzzxxxxxxx'\n"+
""+		"addSound 's3'  ,'zzzxzzzxzzzxzzxz'\n"+
""+		"addSound 's5'  ,'xxzxxzxxzxxzxxxx'\n"+
""+		"rotate 0,1,frame/50\n"+
""+		"box\n";

var industrialMusicExample = ""+
""+		"bpm 350\n"+
""+		"addSound 'additional13'  ,'zzx z zzzzxzzzzzzx'\n"+
""+		"addSound 'additional9'  ,'zxzx z zxzzxxxxxxx'\n"+
""+		"addSound 'additional7'  ,'zzxz z zzzxzzzzzzx'\n"+
""+		"addSound 'additional1'  ,'zzxz z zzzzzzzzzzx'\n"+
""+		"addSound 'additional8'  ,'xzzx z zzxzzzxzzxz'\n"+
""+		"addSound 'additional6' ,'xzxz x zxzxxxzxxxx'\n"+
""+		"addSound 'additional4' ,'zxzxzzzxxzzzzzxx'\n";


function loadExample(whichExample) {

	switch(whichExample) {
		case 'simpleCubeExample':
			editor.setValue(simpleCubeExample);
			break;
		case 'twoCubesExample':
			editor.setValue(twoCubesExample);
			break;
		case 'cubesAndSpikes':
			editor.setValue(cubesAndSpikes);
			break;
		case 'turbineExample':
			editor.setValue(turbineExample);
			break;
		case 'yellowBackgroundExample':
			editor.setValue(yellowBackgroundExample);
			break;
		case 'simpleSoundExample':
			editor.setValue(simpleSoundExample);
			break;
		case 'littleSpiralOfCubes':
			editor.setValue(littleSpiralOfCubes);
			break;
		case 'tentacleExample':
			editor.setValue(tentacleExample);
			break;
		case 'simpleRhythmExample':
			editor.setValue(simpleRhythmExample);
			break;
		case 'industrialMusicExample':
			editor.setValue(industrialMusicExample);
			break;
	}
	
	// setting the value of the editor triggers the
	// codeMirror onChange callback, and that runs
	// the example.
}

	</script>
	
	<script>
  var changesHappened = false;
  var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
    lineNumbers: false,
        tabSize: 2,
        indentUnit: 2,
        indentWithTabs: true,
        lineWrapping: true,
        // We want the code editor to always have focus
        // since there is nothing else to type into.
        // One of those little wonders: you have to pause a little
        // before giving the editor focus, otherwise for some reason
        // the focus is not regained. Go figure.
        onBlur: (function(){ setTimeout('editor.focus()',30) }),
        onChange: (function(){runCode();})
        //onScroll: (function(){alert('scroll')})
  });

  
  editor.setOption("theme", 'night');
  function selectTheme(node) {
    var theme = node.options[node.selectedIndex].innerHTML;
    editor.setOption("theme", theme);
  }

// resizing the text area is necessary otherwise
// as the user types to the end of it, instead of just scrolling
// the content leaving all the other parts of the page where
// they are, it expands and it pushes down
// the view of the page, meaning that the canvas goes up and
// the menu disappears
// so we have to resize it at launch and also every time the window
// is resized.

function resizeTextArea() {
	//alert("code height:" + $('#code').height());
	//alert("window height:" + window.innerHeight);
	//alert("code height:" + $('.CodeMirror-scroll').css('height'));
	//alert("menu height:" + $('#theMenu').height());
	$('.CodeMirror-scroll').css('height',window.innerHeight - $('#theMenu').height()); 
}

$(document).ready(function(){
	editor.focus();
	resizeTextArea()
});


///////////////////////////////////////////////

window.addEventListener(
    'load',
    function () {
        //alert('resizing canvas');
        var canvas = document.getElementById('backGroundCanvas');

        if (fullScreenifyBackground) {
        	fullscreenify(canvas);
        }
    },
    false
);

function fullscreenify(canvas) {
    var style = canvas.getAttribute('style') || '';
    //alert('style: ' +  style);
    
    window.addEventListener('resize', function () {	resizeTextArea(); resize(canvas);}, false);

    resize(canvas);

    function resize(canvas) {
        var scale = {x: 1, y: 1};
        scale.x = (window.innerWidth + 40) / canvas.width;
        scale.y = (window.innerHeight + 40) / canvas.height;
        
        if (scale.x < 1 || scale.y < 1) {
            scale = '1, 1';
        } else if (scale.x < scale.y) {
            scale = scale.x + ', ' + scale.x;
        } else {
            scale = scale.y + ', ' + scale.y;
        }
        
        canvas.setAttribute('style', style + ' ' + '-ms-transform-origin: left top; -webkit-transform-origin: left top; -moz-transform-origin: left top; -o-transform-origin: left top; transform-origin: left top; -ms-transform: scale(' + scale + '); -webkit-transform: scale3d(' + scale + ', 1); -moz-transform: scale(' + scale + '); -o-transform: scale(' + scale + '); transform: scale(' + scale + ');');
    }
}

</script>




<script type="text/javascript" src="./script/soundmanager2.js"></script>
<script type="text/javascript" src="./script/mpc.js"></script>



</body>
</html>
